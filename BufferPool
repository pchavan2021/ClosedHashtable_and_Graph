import java.io.File;
import java.io.IOException;
import java.io.RandomAccessFile;

/**
 * @author pallucha21 and evanhowe03
 * @version 1.0
 */
public class BufferPool {

    private RandomAccessFile disk;
    private Buffer[] pool;
    private int totalBlocksInFile;
    private final static int BLOCK_SIZE = 4096;
    private final static int RECORD_SIZE = 4;
    private int numberOfBuffers;
    private int posFile;

    /**
     * this is the constructor
     * 
     * @param fileName
     *            this is a file
     * @param numBuffers
     *            this a numbuffers
     */
    public BufferPool(File file, int numBuffer) throws IOException {

        posFile = 0;

        numberOfBuffers = numBuffer;

        disk = new RandomAccessFile(file, "rw");

        totalBlocksInFile = (int)disk.length() / (BLOCK_SIZE / 4);

        pool = new Buffer[numBuffer];

        for (int i = 0; i < numBuffer; i++) {

            pool[i] = new Buffer(disk);

        }

    }


    /**
     * insert a buffer into the buffer pool
     * 
     * @param buffer
     *            this is the buffer
     * @throws IOException
     */
    /*
     * public void insert(Record rec, int block) throws IOException {
     * // insert the record into the pool
     * // if the pool is at its capacity
     * // use the LRU to writeBack to the file
     * if (!add(rec, block)) {
     * 
     * Buffer lastBuffer = pool[pool.length - 1];
     * // System.out.println(lastBuffer.toString());
     * lastBuffer.writeBack();
     * insert(rec, block);
     * // System.out.println("AFTER");
     * // System.out.println(lastBuffer.toString());
     * }
     * }
     * 
     */

    public Record getRec(int index) throws IOException {
        // System.out.println("index " + index);
        int bufferArray = index / 4096;
        int pos = index % 1024;
        // System.out.println("bufferArray " + bufferArray);
        // System.out.println("pos " + pos);

        // get a buffer for a specific block from the pool.
        // boolean found = pool.search(block);
        for (int i = 0; i < numberOfBuffers; i++) {
            // System.out.println("I: " + i + "" + " BLCOKS: " + pool[i]
            // .getBlock() + " BUFFERARRAY: " + bufferArray
            // + " INDEX: " + index);
            if (pool[i].getBlock() == bufferArray) {
                // System.out.println("Equal Block");
                // move to front of buffer
                if (i != 0) {
                    Buffer temp = pool[0];
                    pool[0] = pool[i];
                    pool[i] = temp;
                }
                return pool[0].getRec(pos);
            }

        }
        // System.out.println("Equal Block");
        leastRecent();
        System.out.println("LEAST");
        int readIndex = bufferArray * 4096;
        byte[] blockData = new byte[BLOCK_SIZE];

        disk.seek(readIndex);
        disk.readFully(blockData);

        /*
         * for (int y = 0; y < 4096; y += 4) {
         * Record record = new Record();
         * 
         * System.arraycopy(blockData, y, record.getKeyArray(), 0,
         * 2);
         * System.arraycopy(blockData, y + 2, record.getValueArray(),
         * 0, 2);
         * 
         * pool[0].add(record, bufferArray);
         * 
         * }
         */
        Buffer addBuffer = new Buffer(disk);

        for (int y = 0; y < 4096; y += 4) {
            Record record = new Record();

            System.arraycopy(blockData, y, record.getKeyArray(), 0,
                2);
            System.arraycopy(blockData, y + 2, record.getValueArray(),
                0, 2);
            // System.out.println(record.getKey());
            addBuffer.add(record, bufferArray);

        }

        pool[0] = addBuffer;
        for (int u = 0; u < 1024; u++) {
            System.out.println("INDEX: " + u + " key: " + addBuffer
                .getKey(u));
        }
        return pool[0].getRec(index % 1024);

    }


    public void leastRecent() throws IOException {
        pool[numberOfBuffers - 1].writeBack();

        for (int x = numberOfBuffers - 2; x >= 0; x--) {
            pool[x + 1] = pool[x];
        }
        pool[0] = null;
    }


    public short getKey(int index) {

        // return the key for the specific record at the
        // given directions
        // System.out.println(index);

        int block = index / 1024;
        int position = index % 1024;

        for (int i = 0; i < numberOfBuffers; i++) {
            if (block == pool[i].getBlock()) {
                // pool[i].toString();
                return pool[i].getKey(position);
            }
        }
        return 0;

    }


    public void flush() throws IOException {
        // remove all the buffers from the pool
        // write them back into the file
        for (int i = 0; i < pool.length; i++) {
            pool[i].writeBack();

        }
    }


    public int numBlocks() {
        return this.totalBlocksInFile;
    }


    public byte[] getKeyArray(int index) {
        int block = index / BLOCK_SIZE;
        int position = index % BLOCK_SIZE;

        return pool[block].getKeyArray(position);

    }


    public byte[] getValueArray(int index) {
        int block = index / BLOCK_SIZE;
        int position = index % BLOCK_SIZE;

        return pool[block].getKeyArray(position);
    }


    @Override
    public String toString() {
        String fish = "test";
        for (int x = 0; x < pool.length; x++) {
            fish += "Pool buffer index" + x + "";
            fish += pool[x].toString();
        }
        return fish;

    }


    public void setRec(int index, Record record) throws IOException {
        // Calculate block number and offset within the block
        int bufferArray = index / 4096;
        int position = index % 1024;
        for (int i = 0; i < numberOfBuffers; i++) {

            if (pool[i].getBlock() == bufferArray) {
                pool[i].setRecord(position, record);
                pool[i].setDirty(true);
            }

        }

    }

}
